<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>POLICE MUNICIPALE - Cartographie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <style>
        body {
            background-color: #001f3f;
            color: white;
            font-family: 'Arial', sans-serif;
        }

        .header {
            background: linear-gradient(to right, #0056b3, #ffffff, #d32f2f);
            padding: 20px;
            margin-bottom: 30px;
            border-bottom: 4px solid #d32f2f;
        }

        #map {
            height: 70vh;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #0056b3;
        }

        .toolbar {
            background: rgba(0, 31, 63, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #0056b3;
        }

        .tool-button {
            background: linear-gradient(135deg, #001f3f 0%, #0056b3 50%, #00a8e8 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tool-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 86, 179, 0.5);
        }

        .tool-button.active {
            background: linear-gradient(135deg, #28a745 0%, #218838 50%, #1e7e34 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.5);
        }

        .signalement-form {
            background: rgba(0, 31, 63, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #0056b3;
        }

        .signalement-list {
            background: rgba(0, 31, 63, 0.9);
            padding: 20px;
            border-radius: 10px;
            height: 81vh; /* Hauteur de la fenêtre visible */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #0056b3;
        }

        .photo-gallery {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .photo-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #0056b3;
            border-radius: 5px;
            transition: transform 0.2s;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
        }

        .photo-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 600px;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            transform: translate(-50%, -50%);
            border-radius: 10px;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 90vh;
            object-fit: contain;
        }

        .photo-modal .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .signalement-item {
            background: rgba(0, 86, 179, 0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #d32f2f;
        }

        .modal-footer .btn {
            font-weight: 600;
            padding: 10px 20px;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .modal-footer .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-footer .btn:focus {
            outline: 3px solid #0056b3;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="header d-flex justify-content-between align-items-center">
        <img src="Logo_La_Ciota.png" alt="Logo La Ciotat" style="height: 80px;">
        <h1 class="text-center mb-0" style="color: #001f3f; font-family: 'mokoto', sans-serif; font-size: 50px;">CARTOGRAPHIE DES SIGNALEMENTS</h1>
        <img src="Logo_La_Ciota.png" alt="Logo La Ciotat" style="height: 80px;">
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-9">
                <div id="map"></div>
                <div class="toolbar">
                    <button class="tool-button" onclick="nouveauSignalement()"><i class="fas fa-plus"></i> Nouveau Signalement</button>
                    <button class="tool-button" onclick="exporterSignalements()"><i class="fas fa-file-export"></i> Exporter CSV</button>
                    <button class="tool-button" onclick="filtrerSignalements('tous')"><i class="fas fa-list"></i> Tous</button>
                    <button class="tool-button" onclick="filtrerSignalements('DÊPOTS')"><img src="depots.png" style="height: 20px; margin-right: 5px;"/> DÊPOTS</button>
                    <button class="tool-button" onclick="filtrerSignalements('AFFICHAGES')"><img src="affichages.png" style="height: 20px; margin-right: 5px;"/> AFFICHAGES</button>
                    <button class="tool-button" onclick="filtrerSignalements('TAGS')"><img src="tags.png" style="height: 20px; margin-right: 5px;"/> TAGS</button>
                    <button class="tool-button" onclick="filtrerSignalements('AUTRES')"><img src="autres.png" style="height: 20px; margin-right: 5px;"/> AUTRES</button>
                </div>
            </div>
            <div class="col-md-3">
                <div id="signalement-form" class="signalement-form" style="display: none;">
                    <h4>Nouveau Signalement</h4>
                    <form id="form-signalement" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label" for="type">Type</label>
                            <select class="form-control" id="type" name="type" required>
                                <option value="">Sélectionnez un type</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="adresse">Adresse</label>
                            <input type="text" class="form-control" id="adresse" name="adresse" placeholder="Entrez l'adresse du signalement" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="description">Description</label>
                            <textarea class="form-control" id="description" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="photos">Nouvelles photos</label>
                            <!-- Modal pour afficher la photo en grand -->
                            <div class="photo-modal" id="photoModalCustom" onclick="closePhotoModal(event)" style="display:none; width:800px; height:600px; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:2000; border-radius:10px;">
                              <span class="close" style="position:absolute; top:30px; right:40px; color:#fff; font-size:40px; cursor:pointer;" onclick="closePhotoModal(event)">&times;</span>
                              <img src="" alt="Photo en grand format" id="photoModalImg" style="max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 0 20px #000; display:none;">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="photos">Ajouter des photos</label>
                            <input type="file" class="form-control" id="photos" name="files" multiple accept="image/*" onchange="previewSelectedPhotos(event)">
                        </div>
                        <div id="photos-preview" class="photo-gallery"></div>
                        <button type="submit" class="tool-button w-100">Envoyer</button>
                    </form>
                </div>
                <div class="signalement-list">
                    <h4>Signalements Récents</h4>
                    <div id="liste-signalements"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let map;
        let markers = [];
        let selectedLocation = null;
        
        loadInitialData();


        function previewSelectedPhotos(event) {
            const files = event.target.files;
            const gallery = document.getElementById('photos-preview');
            gallery.innerHTML = '';
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Use backticks for template literals
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-thumbnail';
                    gallery.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Définition des icônes personnalisées pour chaque type de signalement
        const typeIcons = {
            'DÊPOTS': L.icon({
                iconUrl: 'depots.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            }),
            'AFFICHAGES': L.icon({
                iconUrl: 'affichages.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            }),
            'TAGS': L.icon({
                iconUrl: 'tags.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            }),
            'AUTRES': L.icon({
                iconUrl: 'autres.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            })
        };

        function initMap() {
            map = L.map('map').setView([43.1741, 5.6067], 14); // La Ciotat

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                selectedLocation = e.latlng;
                if (document.getElementById('signalement-form').style.display === 'block') {
                    placeMarker(selectedLocation);
                }
            });

            chargerSignalements();
        }

        function placeMarker(location) {
            const selectedType = document.getElementById('type');
            if (!selectedType.value) {
                Swal.fire({
                    title: 'Type requis',
                    text: 'Veuillez sélectionner un type de signalement',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const typeText = selectedType.options[selectedType.selectedIndex].textContent;
            const icon = typeIcons[typeText] || new L.Icon.Default();
            let marker = L.marker([location.lat, location.lng], {icon: icon}).addTo(map);
            markers.push(marker);
        }

        function nouveauSignalement() {
            document.getElementById('signalement-form').style.display = 'block';
        }

        async function chargerSignalements(type = 'tous') {
    // Mettre à jour l'état actif des boutons
    document.querySelectorAll('.tool-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeButton = document.querySelector(`.tool-button[onclick="filtrerSignalements('${type}')"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
            // Mapping entre valeurs numériques et libellés
            const typeMapping = {
                '1': 'DÊPOTS',
                '2': 'AFFICHAGES',
                '3': 'TAGS',
                '4': 'AUTRES',
                'DÊPOTS': 'DÊPOTS',
                'AFFICHAGES': 'AFFICHAGES',
                'TAGS': 'TAGS',
                'AUTRES': 'AUTRES'
            };
            try {
                const response = await fetch('/api/signalements');
                const signalements = await response.json();
                // Filtrage pour n'afficher que les signalements visibles
                let signalementsFiltres = signalements.filter(s => s.statut === "visible");
                if (type && type !== 'tous') {
                    signalementsFiltres = signalements.filter(s => {
                        // On mappe la valeur du type du signalement (numérique ou texte) vers le libellé
                        const typeSignalement = typeMapping[s.type] || s.type;
                        return typeSignalement === type;
                    });
                }
                afficherSignalements(signalementsFiltres, type);
            } catch (error) {
                console.error('Erreur lors du chargement des signalements:', error);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const jour = String(date.getDate()).padStart(2, '0');
            const mois = String(date.getMonth() + 1).padStart(2, '0');
            const annee = date.getFullYear();
            const heures = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${jour}/${mois}/${annee} - ${heures}:${minutes}`;
        }

        function afficherSignalements(signalements, type = 'tous') {
            const container = document.getElementById('liste-signalements');
            container.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            signalements.forEach(s => {
                const typeSelect = document.getElementById('type');
                const typeOption = Array.from(typeSelect.options).find(option => option.value === s.type);
                const typeLibelle = typeOption ? typeOption.textContent : s.type || 'Type inconnu';

                const div = document.createElement('div');
                div.className = 'signalement-item';
                div.innerHTML = `
                    <strong>${typeLibelle}</strong><br>
                    ${s.adresse}<br>
                    <button onclick="consulterSignalement(${s.id})" class="tool-button btn-sm"><i class="fas fa-eye"></i> Consulter</button>
                    <button onclick="gererSignalement(${s.id})" class="tool-button btn-sm"><i class="fas fa-cogs"></i> Gérer</button>
                `;

                const modalHtml = `
                    <div class="modal fade" id="modalSignalement${s.id}" tabindex="-1" aria-labelledby="modalSignalementLabel${s.id}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content bg-dark text-white">
                                <div class="modal-header border-bottom border-secondary">
                                    <h5 class="modal-title" id="modalSignalementLabel${s.id}">Détails du Signalement</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer" tabindex="0"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="formSignalement${s.id}" onsubmit="event.preventDefault(); sauvegarderModifications(${s.id}); return false;">
                                        <div class="mb-3">
                                            <label class="form-label">Type</label>
                                            <input type="text" class="form-control" value="${typeLibelle}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Adresse</label>
                                            <input type="text" class="form-control" id="adresse${s.id}" name="adresse${s.id}" value="${s.adresse}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="description${s.id}" name="description${s.id}" rows="3" required>${s.description}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date de création</label>
                                            <input type="text" class="form-control" value="${formatDate(s.dateCreation)}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Utilisateur</label>
                                            <input type="text" class="form-control" value="${s.idUtilisateur}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Brigade</label>
                                            <input type="text" class="form-control" value="${connectedAgentBrigade}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Photos existantes</label>
                                            <div id="photos${s.id}" class="photo-gallery">
                                                ${Array.isArray(s.photos) && s.photos.length > 0 ?
                                                    s.photos.map(photo => `<div class='photo-thumb-wrapper' style='position:relative;display:inline-block;'><img src="/api/signalements/${s.id}/photos/${photo}" class="photo-thumbnail" loading="lazy" alt="Photo du signalement" onclick="openPhotoModal(this.src)"><span class='remove-photo-btn' style='position:absolute;top:2px;right:2px;color:red;cursor:pointer;font-size:20px;' onclick='removeExistingPhoto(event,${s.id},"${photo}")'>&times;</span></div>`).join('\n')
                                                    : '<p class="text-muted">Aucune photo</p>'}
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Ajouter des photos</label>
                                            <input type="file" class="form-control" id="photosInput${s.id}" name="files" multiple accept="image/*" onchange="previewModalSelectedPhotos(event,${s.id})">
                                        </div>
                                        <div id="photos-preview-modal${s.id}" class="photo-gallery"></div>
                                        <div class="modal-footer">
                                            <button type="submit" class="tool-button">Sauvegarder</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                container.appendChild(div);

                // Utiliser le type de signalement pour sélectionner l'icône appropriée
                const icon = typeIcons[typeLibelle] || new L.Icon.Default();
                if (s.latitude && s.longitude) {
                    const marker = L.marker([s.latitude, s.longitude], {
                        title: typeLibelle,
                        icon: icon
                    }).addTo(map)
                    .on('click', function() {
                        consulterSignalement(s.id);
                    });
                    markers.push(marker);
                }
            });
        }

        async function consulterSignalement(id) {
            const modal = new bootstrap.Modal(document.getElementById(`modalSignalement${id}`));
            modal.show();
        }

        function gererSignalement(id) {
            // Afficher la modal personnalisée Bootstrap pour la gestion du signalement
            const modal = new bootstrap.Modal(document.getElementById(`modalGestionSignalement`));
            // Stocker l'ID du signalement dans la modal pour les actions (archiver/supprimer)
            document.getElementById('gestion-signalement-id').value = id;
            modal.show();
        }

        async function supprimerSignalement(id) {
            console.log('supprimerSignalement appelée pour id:', id);
            console.log('connectedAgentPouvoir:', connectedAgentPouvoir);

            if (connectedAgentPouvoir === 'admin' || connectedAgentPouvoir === 'userCb') {
                // Nouvelle confirmation explicite avant suppression définitive
                const confirmation = await Swal.fire({
                    title: 'Confirmation de suppression',
                    html: '<div style="font-size:1.1rem;color:#d32f2f;"><b>Attention :</b> Cette action est <b>définitive</b>.<br>Toutes les données liées à ce signalement, y compris celles utilisées pour les statistiques, seront <b>effacées définitivement</b>.<br>Voulez-vous vraiment continuer ?</div>',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Oui, supprimer définitivement',
                    cancelButtonText: 'Annuler',
                    focusCancel: true,
                    background: 'linear-gradient(135deg, #001f3f 0%, #0056b3 100%)',
                    customClass: {
                        popup: 'swal2-dialog-custom',
                        title: 'swal-title-custom',
                        htmlContainer: 'swal-html-custom',
                        cancelButton: 'swal-cancel-custom',
                        confirmButton: 'swal-confirm-custom'
                    }
                });
                if (confirmation.isConfirmed) {
                    try {
                        const response = await fetch(`/api/signalements/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            Swal.fire({
                                title: 'Suppression réussie',
                                text: 'Le signalement a été supprimé avec succès.',
                                icon: 'success',
                                confirmButtonText: 'OK',
                                didClose: () => { 
                                    Swal.close(); 
                                    const modalGestion = bootstrap.Modal.getInstance(document.getElementById('modalGestionSignalement'));
                                    if (modalGestion) {
                                        modalGestion.hide();
                                    }
                                }
                            });
                            chargerSignalements();
                        } else {
                            Swal.fire({
                                title: 'Erreur',
                                text: "Une erreur est survenue lors de la suppression du signalement.",
                                icon: 'error',
                                confirmButtonText: 'OK',
                                didClose: () => { Swal.close(); }
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            title: 'Erreur',
                            text: "Impossible de supprimer le signalement.",
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                } else {
                    // Annulation explicite
                    Swal.fire({
                        title: 'Suppression annulée',
                        text: 'Aucune donnée n\'a été supprimée.',
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                }
            } else {
                Swal.fire({
                    title: 'Accès refusé',
                    text: "Vous n'avez pas les autorisations nécessaires pour supprimer ce signalement. Veuillez contacter un administrateur ou un chef de brigade.",
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            }
        }

        function fermerModal(id) {
            const modalElement = document.getElementById(`modalSignalement${id}`);
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        async function sauvegarderModifications(id) {
            console.log('sauvegarderModifications appelée pour id:', id);
            try {
                const formData = new FormData();
                formData.append('description', document.getElementById(`description${id}`).value);
                // Ajout de la récupération de la nouvelle adresse modifiée
                const adresseInput = document.getElementById(`adresse${id}`);
                if (adresseInput) {
                    formData.append('adresse', adresseInput.value);
                }
                const filesInput = document.querySelector(`#modalSignalement${id} input[type=file]`);
                console.log('filesInput.files:', filesInput.files); // Ajout du log ici

                if (filesInput && filesInput.files.length > 0) {
                    for (let i = 0; i < filesInput.files.length; i++) {
                        const file = filesInput.files[i];
                        console.log('Fichier ajouté au FormData:', file); // Ajout du log ici
                        formData.append('files', file);
                    }
                }

                const response = await fetch(`/api/signalements/${id}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    Swal.fire({
                        title: 'Succès',
                        text: 'Modifications enregistrées avec succès',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    fermerModal(id);
                    chargerSignalements();
                } else {
                    throw new Error('Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur:', error);
                Swal.fire({
                    title: 'Erreur',
                    text: 'Une erreur est survenue lors de la sauvegarde',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Correction des boutons de filtre pour appeler chargerSignalements avec le bon type
        function filtrerSignalements(type) {
    // Supprimer la classe active de tous les boutons
    document.querySelectorAll('.tool-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ajouter la classe active au bouton cliqué
    const activeButton = document.querySelector(`.tool-button[onclick="filtrerSignalements('${type}')"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
            chargerSignalements(type);
        }

        function exporterSignalements() {
            window.location.href = '/api/signalements/export';
        }

        function  loadInitialData() {
            // Charger l'imatricul de l'agent connecté
            fetch('/api/user-info')
            .then(response => response.json())
            .then(userInfo => {
                connectedAgentId = userInfo.matricule;
                connectedAgentBrigade = userInfo.brigade;
                connectedAgentPouvoir = userInfo.pouvoir
            })
            .catch(error => console.error('Erreur chargement agents:', error));
        }

        document.getElementById('form-signalement').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!selectedLocation) {
                alert('Veuillez sélectionner un emplacement sur la carte');
                return;
            }

            const formData = new FormData();
            formData.append('type', document.getElementById('type').value);
            formData.append('adresse', document.getElementById('adresse').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('latitude', selectedLocation.lat);
            formData.append('longitude', selectedLocation.lng);
            formData.append('idUtilisateur', connectedAgentId);
            const photosInput = document.getElementById('photos');
            if (photosInput && photosInput.files && photosInput.files.length > 0) {
                for (let photo of photosInput.files) {
                    formData.append('files', photo);
                }
            }

            try {
                const response = await fetch('/api/signalements', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la création du signalement');
                }

                document.getElementById('form-signalement').reset();
                document.getElementById('signalement-form').style.display = 'none';
                selectedLocation = null;
                chargerSignalements();
            } catch (error) {
                console.error('Erreur lors de la création du signalement:', error);
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur lors de la création du signalement',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });

        async function chargerTypesSignalement() {
            try {
                const response = await fetch('/api/types-signalement');
                const types = await response.json();
                const selectType = document.getElementById('type');
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.libelle;
                    option.title = type.description; // Ajouter l'infobulle avec la description
                    selectType.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des types de signalement:', error);
            }
        }

        // MODAL PHOTO AGRANDIE
        function openPhotoModal(photoUrl) {
            // Extraire le nom du fichier à partir de l'URL
            const fileName = photoUrl.split('_').pop().split('?')[0];
            
            Swal.fire({
                title: fileName,
                html: `<img src="${photoUrl}" alt="Photo du signalement" style="max-width:90vw; max-height:80vh; border-radius:8px; box-shadow:0 0 20px #000;">`,
                showCloseButton: true,
                showConfirmButton: false,
                background: 'rgba(0,0,0,0.95)',
                width: 850,
                customClass: {
                    popup: 'photo-modal-swal'
                }
            });
        }
        function closePhotoModal(event) {
            const modal = document.getElementById('photoModalCustom');
            if (event && event.target && (event.target === modal || event.target.classList.contains('close'))) {
                modal.style.display = 'none';
                document.getElementById('photoModalImg').src = '';
            }
        }

        window.onload = async function() {
            initMap();
            await chargerTypesSignalement();
        };

        function archiverSignalement(id) {
            Swal.fire({
                title: 'Archiver ce signalement ?',
                text: 'Cette action rendra le signalement invisible sur la carte.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Oui, archiver',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/signalements/${id}/archive`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire({
                                title: 'Archivé !',
                                text: 'Le signalement a été archivé avec succès.',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });
                            chargerSignalements();
                        } else {
                            Swal.fire({
                                title: 'Erreur',
                                text: "Impossible d'archiver le signalement.",
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Erreur',
                            text: "Une erreur s'est produite lors de l'archivage.",
                            icon: 'error'
                        });
                    });
                }
            });
        }

                // Ajout de la gestion dynamique des miniatures dans la modal Détails du Signalement
        function previewModalSelectedPhotos(event, signalementId) {
            const files = event.target.files;
            const gallery = document.getElementById('photos' + signalementId);
            // On conserve les miniatures déjà ajoutées lors de cette session (non sauvegardées)
            let previews = gallery.querySelectorAll('.photo-thumbnail.new');
            previews.forEach(p => p.parentNode.remove());
            Array.from(files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Création du conteneur pour miniature + croix
                    const wrapper = document.createElement('div');
                    wrapper.className = 'photo-thumb-wrapper';
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'inline-block';
                    // Miniature
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-thumbnail new';
                    img.setAttribute('data-file-idx', idx);
                    // Croix de suppression
                    const removeBtn = document.createElement('span');
                    removeBtn.className = 'remove-photo-btn';
                    removeBtn.style.position = 'absolute';
                    removeBtn.style.top = '2px';
                    removeBtn.style.right = '2px';
                    removeBtn.style.color = 'red';
                    removeBtn.style.cursor = 'pointer';
                    removeBtn.style.fontSize = '20px';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = function(ev) {
                        ev.stopPropagation();
                        // Supprimer la miniature
                        wrapper.remove();
                        // Supprimer le fichier du FileList (nécessite de recréer un nouvel input file)
                        removeFileFromInput('photosInput' + signalementId, idx);
                    };
                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                    gallery.appendChild(wrapper);
                };
                reader.readAsDataURL(file);
            });
        }
        // Fonction utilitaire pour supprimer un fichier du FileList (recréation de l'input)
        function removeFileFromInput(inputId, idxToRemove) {
            const input = document.getElementById(inputId);
            const dt = new DataTransfer();
            Array.from(input.files).forEach((file, idx) => {
                if (idx !== idxToRemove) {
                    dt.items.add(file);
                }
            });
            input.files = dt.files;
        }
    </script>
</body>
</html>

<!-- Modal personnalisée pour la gestion du signalement -->
<div class="modal fade" id="modalGestionSignalement" tabindex="-1" aria-labelledby="modalGestionSignalementLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white" style="border-radius: 15px; border: 2px solid #0056b3;">
      <div class="modal-header border-bottom border-secondary">
        <h5 class="modal-title" id="modalGestionSignalementLabel"><i class="fas fa-cogs"></i> Gestion du signalement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="gestion-signalement-id" value="">
        <p class="mb-4"><i class="fas fa-info-circle text-info"></i> Que souhaitez-vous faire avec ce signalement ?</p>
        <div class="d-flex flex-column gap-2">
          <button class="tool-button" style="background:linear-gradient(135deg,#28a745 0%,#218838 50%,#1e7e34 100%);" onclick="archiverSignalement(document.getElementById('gestion-signalement-id').value)"><i class="fas fa-archive"></i> Archiver</button>
          <button class="tool-button" style="background:linear-gradient(135deg,#d32f2f 0%,#b71c1c 100%);" onclick="supprimerSignalement(document.getElementById('gestion-signalement-id').value)"><i class="fas fa-trash-alt"></i> Supprimer</button>
        </div>
      </div>
      <div class="modal-footer border-top border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
</script>
</body>
</html>



