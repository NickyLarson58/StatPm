<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>POLICE MUNICIPALE - Cartographie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            background-color: #001f3f;
            color: white;
            font-family: 'Arial', sans-serif;
        }

        .header {
            background: linear-gradient(to right, #0056b3, #ffffff, #d32f2f);
            padding: 20px;
            margin-bottom: 30px;
            border-bottom: 4px solid #d32f2f;
        }

        #map {
            height: 70vh;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #0056b3;
        }

        .toolbar {
            background: rgba(0, 31, 63, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #0056b3;
        }

        .tool-button {
            background: linear-gradient(135deg, #001f3f 0%, #0056b3 50%, #00a8e8 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tool-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 86, 179, 0.5);
        }

        .signalement-form {
            background: rgba(0, 31, 63, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #0056b3;
        }

        .signalement-list {
            background: rgba(0, 31, 63, 0.9);
            padding: 20px;
            border-radius: 10px;
            height: 81vh; /* Hauteur de la fenêtre visible */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #0056b3;
        }

        .signalement-item {
            background: rgba(0, 86, 179, 0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #d32f2f;
        }
    </style>
</head>
<body>
    <div class="header d-flex justify-content-between align-items-center">
        <img src="Logo_La_Ciota.png" alt="Logo La Ciotat" style="height: 80px;">
        <h1 class="text-center mb-0" style="color: #001f3f; font-family: 'mokoto', sans-serif; font-size: 50px;">CARTOGRAPHIE DES SIGNALEMENTS</h1>
        <img src="Logo_La_Ciota.png" alt="Logo La Ciotat" style="height: 80px;">
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-9">
                <div id="map"></div>
                <div class="toolbar">
                    <button class="tool-button" onclick="nouveauSignalement()"><i class="fas fa-plus"></i> Nouveau Signalement</button>
                    <button class="tool-button" onclick="exporterSignalements()"><i class="fas fa-file-export"></i> Exporter CSV</button>
                    <button class="tool-button" onclick="filtrerSignalements('tous')"><i class="fas fa-list"></i> Tous</button>
                    <button class="tool-button" onclick="filtrerSignalements('en_attente')"><i class="fas fa-clock"></i> En Attente</button>
                    <button class="tool-button" onclick="filtrerSignalements('valide')"><i class="fas fa-check"></i> Validés</button>
                </div>
            </div>
            <div class="col-md-3">
                <div id="signalement-form" class="signalement-form" style="display: none;">
                    <h4>Nouveau Signalement</h4>
                    <form id="form-signalement">
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-control" id="type" required>
                                <option value="">Sélectionnez un type</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="description" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Photos</label>
                            <input type="file" class="form-control" id="photos" multiple accept="image/*">
                        </div>
                        <button type="submit" class="tool-button w-100">Envoyer</button>
                    </form>
                </div>
                <div class="signalement-list">
                    <h4>Signalements Récents</h4>
                    <div id="liste-signalements"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let map;
        let markers = [];
        let selectedLocation = null;

        function initMap() {
            map = L.map('map').setView([43.1741, 5.6067], 14); // La Ciotat

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                selectedLocation = e.latlng;
                if (document.getElementById('signalement-form').style.display === 'block') {
                    placeMarker(selectedLocation);
                }
            });

            chargerSignalements();
        }

        function placeMarker(location) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            let marker = L.marker([location.lat, location.lng]).addTo(map);
            markers.push(marker);
        }

        function nouveauSignalement() {
            document.getElementById('signalement-form').style.display = 'block';
        }

        async function chargerSignalements() {
            try {
                const response = await fetch('/api/signalements');
                const signalements = await response.json();
                afficherSignalements(signalements);
            } catch (error) {
                console.error('Erreur lors du chargement des signalements:', error);
            }
        }

        function afficherSignalements(signalements) {
            const container = document.getElementById('liste-signalements');
            container.innerHTML = '';
            markers.forEach(m => m.setMap(null));
            markers = [];

            signalements.forEach(s => {
                // Ajouter à la liste
                const div = document.createElement('div');
                div.className = 'signalement-item';
                div.innerHTML = `
                    <strong>${s.type}</strong><br>
                    ${s.description}<br>
                    <small>Statut: ${s.statut}</small><br>
                    <button onclick="modererSignalement(${s.id}, 'valide')" class="tool-button btn-sm">Valider</button>
                    <button onclick="modererSignalement(${s.id}, 'rejete')" class="tool-button btn-sm">Rejeter</button>
                `;
                container.appendChild(div);

                // Ajouter sur la carte
                const marker = L.marker([s.latitude, s.longitude], {
                    title: s.type
                }).addTo(map);
                markers.push(marker);
            });
        }

        async function modererSignalement(id, statut) {
            try {
                await fetch(`/api/signalements/${id}/moderation?statut=${statut}`, {
                    method: 'PUT'
                });
                chargerSignalements();
            } catch (error) {
                console.error('Erreur lors de la modération:', error);
            }
        }

        async function filtrerSignalements(statut) {
            try {
                const url = statut === 'tous' ? '/api/signalements' : `/api/signalements?statut=${statut}`;
                const response = await fetch(url);
                const signalements = await response.json();
                afficherSignalements(signalements);
            } catch (error) {
                console.error('Erreur lors du filtrage:', error);
            }
        }

        function exporterSignalements() {
            window.location.href = '/api/signalements/export';
        }

        function  loadInitialData() {
            // Charger l'imatricul de l'agent connecté
            fetch('/api/user-info')
            .then(response => response.json())
            .then(userInfo => {
                connectedAgentId = userInfo.matricule;
            })
            .catch(error => console.error('Erreur chargement agents:', error));
        }
        loadInitialData();

        document.getElementById('form-signalement').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!selectedLocation) {
                alert('Veuillez sélectionner un emplacement sur la carte');
                return;
            }

            const formData = {
                type: document.getElementById('type').value,
                description: document.getElementById('description').value,
                latitude: selectedLocation.lat,
                longitude: selectedLocation.lng,
                idUtilisateur: connectedAgentId
            };

            try {
                const response = await fetch('/api/signalements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const nouveauSignalement = await response.json();

                // Upload des photos si présentes
                const photos = document.getElementById('photos').files;
                if (photos.length > 0) {
                    const photoFormData = new FormData();
                    for (let photo of photos) {
                        photoFormData.append('files', photo);
                    }

                    await fetch(`/api/signalements/${nouveauSignalement.id}/photos`, {
                        method: 'POST',
                        body: photoFormData
                    });
                }

                document.getElementById('form-signalement').reset();
                document.getElementById('signalement-form').style.display = 'none';
                selectedLocation = null;
                chargerSignalements();
            } catch (error) {
                console.error('Erreur lors de la création du signalement:', error);
            }
        });

        async function chargerTypesSignalement() {
            try {
                const response = await fetch('/api/types-signalement');
                const types = await response.json();
                const selectType = document.getElementById('type');
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.libelle;
                    option.title = type.description; // Ajouter l'infobulle avec la description
                    selectType.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des types de signalement:', error);
            }
        }

        window.onload = async function() {
            initMap();
            await chargerTypesSignalement();
        };
    </script>
</body>
</html>